<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
	"http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xml:lang="en" lang="en" xmlns="http://www.w3.org/1999/xhtml">
<head>
<script>
  var dbg;
  var xmlhttp;
  var canvas, ctx;
  var ww, wh;
  var hmax, hfact;
  var tmin, tmax, tfact;
  var xzero = 20, yzero = 20;
  var cold_d = [], hot_d = [];

  function showdate(utime) {
    var dt = new Date(utime*1000);
    return dt.toLocaleDateString() + " " + dt.toLocaleTimeString();
  }

  function getcomb(lo, hi) {
    var comb = [], lb = [];
    var d = hi - lo;
    var ord = Math.pow(10, Math.floor(Math.log10(d)));
    var scl = Math.floor(d / ord);
    var inc, inc2, first, x, lb;

    if (scl < 2) { inc = 0.1; inc2 = 0.5; }
    else if (scl < 5) { inc = 0.2; inc2 = 1; }
    else { inc = 0.5; inc2 = 2; }
    inc *= ord;
    inc2 *= ord;
    first = (Math.floor(lo / inc) + 1) * inc;
    for (x = 0; x < (d / inc) - 1.5; x++)
      comb.push(first + inc * x);
    first = (Math.floor(lo / inc2) + 1) * inc2;
    for (x = 0; x < (d / inc2) - 1.5; x++)
      lb.push(first + inc2 * x);
    //dbg.innerHTML = "ord=" + ord + "<br>inc=" + inc + "<br>"
    //              + comb + "<br>" + lb;
    return [comb, lb];
  }

  function px(x) {
    return xzero + ((x - tmin) * tfact);
  }

  function py(y) {
    return wh - yzero - (y * hfact);
  }

  function xaxis() {
    ctx.beginPath();
    ctx.moveTo(px(tmin), py(0));
    ctx.lineTo(px(tmax), py(0));
    ctx.strokeStyle = "black";
    ctx.stroke();
  }

  function yaxis() {
    var comb = getcomb(0, hmax);
    var i;

    ctx.beginPath();
    for (i = 0; comb[0][i]; i++) {
      ctx.moveTo(px(tmin) - 5, py(comb[0][i]));
      ctx.lineTo(px(tmax), py(comb[0][i]));
    }
    ctx.strokeStyle = "lightgray";
    ctx.stroke();

    ctx.beginPath();
    ctx.moveTo(px(tmin), py(0));
    ctx.lineTo(px(tmin), py(hmax));
    ctx.strokeStyle = "black";
    ctx.stroke();

    ctx.fillStyle = "black";
    ctx.font = "bold 8px Courier";
    ctx.fillText(0, px(tmin) - 8, py(0));
    for (i = 0; comb[1][i]; i++) {
      ctx.fillText(comb[1][i], px(tmin) - xzero + 2, py(comb[1][i]));
    }
    ctx.fillText("l/h", px(tmin) + 2, py(hmax) + 8);
  }

  /* @ updates global var `hmax` */
  function differentiate(times) {
    var res = [];
    var dv, dt, v;

    for (i = 0; i < times.length - 1; i++) {
      dv = times[i+1][1] - times[i][1];
      dt = times[i+1][0] - times[i][0];
      if (dt != 0 && dv != 0) {
        v = (dv / dt) * 360 ; /* Litres per hour */
        if (hmax < v) hmax = v;
        res.push([times[i][0], v]);
      }
    }
    res.push([times[i][0], v]);

    return res;
  }

  function drawplot(data, color) {
    var i;

    ctx.beginPath();
    ctx.moveTo(px(data[0][0]), py(data[0][1]));
    for (i = 1; i < data.length; i++) {
      ctx.lineTo(px(data[i][0]), py(data[i - 1][1]));
      ctx.lineTo(px(data[i][0]), py(data[i][1]));
    }
    ctx.strokeStyle = color;
    ctx.stroke();
  }

  function showloading() {
    ctx.fillStyle = "green";
    ctx.font = "bold 16px Courier";
    ctx.fillText("loading", (ww / 2) - 40 , (wh / 2) + 8);
  }

  function clearplot() {
    ctx.clearRect(0, 0, ww, wh);
  }

  function redraw() {
    if (cold_d.length && hot_d.length) {
      tfact = (ww - xzero) / (tmax - tmin);
      hfact = (wh - yzero) / hmax;
      clearplot();
      xaxis();
      yaxis();
      drawplot(cold_d, "blue");
      drawplot(hot_d, "red");
    } else {
      showloading();
    }
  }

  function gotdata(data) {
    document.getElementById("cold").innerHTML =
      (data.current.cold / 100).toFixed(2);
    document.getElementById("hot").innerHTML =
      (data.current.hot / 100).toFixed(2);
    tmin = data.range.lo;
    tmax = data.range.hi;
    dbg.innerHTML = "from " + tmin + " to " + tmax
                  + "<br>from " + showdate(tmin) + " to " + showdate(tmax);
    /* differetiate() updates hmax */
    hmax = 0;
    cold_d = differentiate(data.cold);
    hot_d = differentiate(data.hot);
    //dbg.innerHTML = "hmax=" + hmax + " hfact=" + hfact + "<br>"
    //              + cold_d + "<br>" + hot_d;
    redraw();
  }

  function iso2qu(idate) {
    return idate.replace("T", "+").replace("0Z", "");
  }

  function sendquery(lo, hi) {
    var url = "query.cgi" + "?lo=" + iso2qu(lo) + "&hi=" + iso2qu(hi);

    //dbg.innerHTML = url;
    xmlhttp.onreadystatechange = function() {
      if (xmlhttp.readyState == 4 && xmlhttp.status == 200) {
        // dbg.innerHTML = xmlhttp.responseText;
        var myData = JSON.parse(xmlhttp.responseText);
        gotdata(myData);
      }
    }
    xmlhttp.open("GET", url, true);
    xmlhttp.send();
  }

  function resize() {
    ww = window.innerWidth - 4;
    if (ww > window.innerHeight) ww = window.innerHeight;
    wh = ww / 2;
    canvas.width = ww;
    canvas.height = wh;
    canvas.style.width = ww + "px";
    canvas.style.height = wh + "px";
    redraw();
  }

  function initialize() {
    var tdy = new Date();
    var tmr;

    tdy.setMilliseconds(0);
    tdy.setSeconds(0);
    tdy.setMinutes(0);
    tdy.setHours(0);
    tmr = new Date(1*tdy + 86400000);
    dbg = document.getElementById("debug");
    canvas = document.getElementById("plot");
    ctx = canvas.getContext("2d");
    resize();
    
    xmlhttp = new XMLHttpRequest();
    sendquery(tdy.toISOString(), tmr.toISOString());
  }

  /* Set up */
  if(window.attachEvent) {
    window.attachEvent('onload', initialize);
    window.attachEvent('onresize', resize);
  } else {
    window.onload = initialize;
    window.onresize = resize;
  }
</script>
<style>
@font-face {
  font-family: PipeDream;
  src: url('PIPED.TTF') format('truetype');
  /* Free to use font from http://www.mlink.net/~paterson/jpfonts.htm */
}
h1 {
  margin-top: 5px;
  text-align: center;
  font-family: PipeDream;
  font-size: 64px;
  font-weight: normal;
  background-color: lightgray;
}
br {
  clear: both;
}
div#currentvals {
  width: 18em;
  margin-left: auto;
  margin-right: auto;
  margin-bottom: 10px;
  text-align: center;
  font-size: 150%;
}
div.current {
  position: relative;
  padding: 0.2em;
  border: solid 1px black;
  margin: 0.2em;
}
div#cold {
  float: left;
  background-color: #d0e0ff;
}
div#hot {
  float: right;
  background-color: #ffd0e0;
}
canvas#plot {
  padding: 0px;
  margin: auto;
  display: block;
  width: 640px;
  height: 320px;
  border: solid 1px black;
}
body {
  margin: 0px;
}
</style>
<title>Water Meters</title>
</head><body>
<h1>WATER METERS</h1>
<div id="currentvals">
  Current Values
  <div class="current" id="cold">cold</div>
  <div class="current" id="hot">hot</div>
</div>
<br />
<canvas id="plot" width="640" height = "320"></canvas>
<br />
<div id=debug>
</div>
</body>
